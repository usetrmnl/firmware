<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TRMNL Wi-Fi Configuration</title>
  <style>
    table {
      border-spacing: 1;
      border-collapse: collapse;
      background: white;
      border-radius: 4px;
      overflow: hidden;
      width: 100%;
      margin: 0 auto;
      position: relative;
    }

    table td,
    table th {
      padding-left: 8px;
      text-align: left;
    }

    table td {
      text-align: right;
    }

    table tbody tr {
      height: 30px;
      border-bottom: 1px solid #BBBB;
      font-size: 16px;
    }

    table tbody.hoverable tr:hover {
      background: #f2f2f2;
    }

    .selected {
      background-color: #BBBB;
    }

    body {
      font: 400 14px 'Calibri', 'Arial';
    }

    blockquote {
      color: white;
      text-align: center;
    }

    #loader-wrapper {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }

    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
    }

    #loader:before {
      content: "";
      display: block;
      position: absolute;
      border-style: solid;
      border-color: #fff;
      border-top-color: transparent;
      border-width: 6px;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      top: 10px;
      left: 10px;
      animation: loader-spin 1s linear infinite;
    }

    @keyframes loader-spin {
      0% {
        transform: rotate(0);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #loader-wrapper {
      display: none;
    }

    .div-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 30px 30px 30px 30px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 20px;
      width: 100%;
    }

    label {
      font-size: 18px;
      margin-bottom: 5px;
    }

    input {
      border-width: 1px;
      border-radius: .75rem;
      font-size: 16px;
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border: 2px solid #F86527;
      border-radius: .75rem;
    }

    input::placeholder {
      opacity: 70%;
    }

    .button {
      color: #fff;
      border: none;
      padding: 8px 18px;
      font-size: 18px;
      border-radius: 5px;
    }

    .button:disabled {
      opacity: .65;
    }

    .button-success {
      background-color: #F86527;
    }

    .button-primary {
      background-color: #e4eaf0;
      color: #212529;
    }

    .button-primary:hover:not([disabled]) {
      background-color: #d7dfe8;
    }

    .button-secondary {
      background-color: #343a40;
    }

    .button-secondary:hover:not([disabled]) {
      background-color: #3e444a;
    }

    .button:hover:not([disabled]) {
      filter: saturate(0.8);
    }

    h1 {
      text-align: center;
    }

    .alert-primary {
      color: #383d41;
      background-color: #e2e3e5;
      border-color: #d6d8db;
    }

    .alert-warning {
      color: #856404;
      background-color: #fff3cd;
      border-color: #ffeeba;
    }

    .alert {
      position: relative;
      padding: .75rem 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid transparent;
      border-radius: .25rem;
      margin-left: auto;
      margin-right: auto;
    }

    #toggler {
      position: absolute;
      font-size: 20px;
      right: 50px;
      cursor: pointer;
      margin-top: 32px;
    }

    caption {
      padding-top: .5rem;
      padding-bottom: .5rem;
      color: #6c757d;
      text-align: left;
    }

    .bi::before {
      display: inline-block;
      content: "";
      vertical-align: -.125em;
      background-repeat: no-repeat;
      background-size: 1rem 1rem;
      width: 20px;
      height: 20px;
    }

    .bi-wifi::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-wifi' viewBox='0 0 16 16'><path d='M15.384 6.115a.485.485 0 0 0-.047-.736A12.44 12.44 0 0 0 8 3C5.259 3 2.723 3.882.663 5.379a.485.485 0 0 0-.048.736.52.52 0 0 0 .668.05A11.45 11.45 0 0 1 8 4c2.507 0 4.827.802 6.716 2.164.205.148.49.13.668-.049'/><path d='M13.229 8.271a.482.482 0 0 0-.063-.745A9.46 9.46 0 0 0 8 6c-1.905 0-3.68.56-5.166 1.526a.48.48 0 0 0-.063.745.525.525 0 0 0 .652.065A8.46 8.46 0 0 1 8 7a8.46 8.46 0 0 1 4.576 1.336c.206.132.48.108.653-.065m-2.183 2.183c.226-.226.185-.605-.1-.75A6.5 6.5 0 0 0 8 9c-1.06 0-2.062.254-2.946.704-.285.145-.326.524-.1.75l.015.015c.16.16.407.19.611.09A5.5 5.5 0 0 1 8 10c.868 0 1.69.201 2.42.56.203.1.45.07.61-.091zM9.06 12.44c.196-.196.198-.52-.04-.66A2 2 0 0 0 8 11.5a2 2 0 0 0-1.02.28c-.238.14-.236.464-.04.66l.706.706a.5.5 0 0 0 .707 0l.707-.707z'/></svg>");
    }

    .bi-wifi-1::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-wifi-1' viewBox='0 0 16 16'><path d='M11.046 10.454c.226-.226.185-.605-.1-.75A6.5 6.5 0 0 0 8 9c-1.06 0-2.062.254-2.946.704-.285.145-.326.524-.1.75l.015.015c.16.16.407.19.611.09A5.5 5.5 0 0 1 8 10c.868 0 1.69.201 2.42.56.203.1.45.07.611-.091zM9.06 12.44c.196-.196.198-.52-.04-.66A2 2 0 0 0 8 11.5a2 2 0 0 0-1.02.28c-.238.14-.236.464-.04.66l.706.706a.5.5 0 0 0 .707 0l.708-.707z'/></svg>");
    }

    .bi-wifi-2::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-wifi-2' viewBox='0 0 16 16'><path d='M13.229 8.271c.216-.216.194-.578-.063-.745A9.46 9.46 0 0 0 8 6c-1.905 0-3.68.56-5.166 1.526a.48.48 0 0 0-.063.745.525.525 0 0 0 .652.065A8.46 8.46 0 0 1 8 7a8.46 8.46 0 0 1 4.577 1.336c.205.132.48.108.652-.065m-2.183 2.183c.226-.226.185-.605-.1-.75A6.5 6.5 0 0 0 8 9c-1.06 0-2.062.254-2.946.704-.285.145-.326.524-.1.75l.015.015c.16.16.408.19.611.09A5.5 5.5 0 0 1 8 10c.868 0 1.69.201 2.42.56.203.1.45.07.611-.091zM9.06 12.44c.196-.196.198-.52-.04-.66A2 2 0 0 0 8 11.5a2 2 0 0 0-1.02.28c-.238.14-.236.464-.04.66l.706.706a.5.5 0 0 0 .708 0l.707-.707z'/></svg>");
    }

    .bi-eye::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-eye' viewBox='0 0 16 16'><path d='M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z'/><path d='M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0'/></svg>");
    }

    .bi-eye-slash::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-eye-slash' viewBox='0 0 16 16'><path d='M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7 7 0 0 0-2.79.588l.77.771A6 6 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755q-.247.248-.517.486z'/><path d='M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829'/><path d='M3.35 5.47q-.27.24-.518.487A13 13 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7 7 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12z'/></svg>");
    }

    .bi-lock::before {
      background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-lock' viewBox='0 0 16 16'><path d='M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1'/></svg>");
    }

    .loader {
      border: 6px solid #f3f3f3;
      border-radius: 50%;
      border-top: 6px solid #F86527;
      width: 40px;
      height: 40px;
      -webkit-animation: spin 2s linear infinite;
      /* Safari */
      animation: spin 2s linear infinite;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }

    .modal-footer {
      text-align: right;
      margin-top: 20px;
    }

    /* Safari */
    @-webkit-keyframes spin {
      0% {
        -webkit-transform: rotate(0deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <script>
    function refresh() {
      location.reload();
    }

    function connect() {
      hideAlert();
      var ssid = document.getElementById('ssid').value;
      var pswd = document.getElementById('password').value;
      var server = document.getElementById('server').value;
      if (!ssid) {
        displayAlert('Please enter your Wi-Fi name', "warning");
        return;
      }

      // if custom server form-group is visible, validate the url
      let customServerVisible = document.getElementById('custom_server_form_group').style.display != 'none';
      if (customServerVisible && server) {
        try {
          new URL(server);
          // does it start with http:// or https://?
          if (!server.startsWith('http://') && !server.startsWith('https://')) {
            throw new Error();
          }
        } catch (_) {
          displayAlert('Please enter a valid URL for your custom server', "warning");
          return;
        }
      }

      // strip trailing slashes
      server = server.trim();
      server = server.replace(/\/+$/, '');

      var body = { ssid: ssid, pswd: pswd, server: server };

      showLoader();
      fetch('/connect', {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      })
        .then(response => response.json())
        .then(response => {
          displayWifiInfo(response);
          hideLoader();
        })
        .catch(_ => {
          hideLoader();
        });
    }

    function confirmSoftReset() {
      document.getElementById('confirmationModal').style.display = 'block';
    }

    function confirmCustomServer() {
      document.getElementById('customServerWarningModal').style.display = 'block';
    }

    function showCustomServerInput() {
      document.getElementById('custom_server_form_group').style.display = 'flex';
      closeCustomServerModal();
    }

    function closeCustomServerModal() {
      document.getElementById('customServerWarningModal').style.display = 'none';
    }

    function softReset() {
      closeModal();
      showLoader();
      fetch('/soft-reset', {
        method: 'GET',
      })
        .then(_ => {
          hideLoader();
          displayAlert('Soft reset completed succesfully. Your settings have been restored to their default values.', "primary");
        })
        .catch(_ => {
          hideLoader();
          displayAlert('An error occured during the soft reset. Please try again or contact support if the issue persists.', "warning");
        });
    }

    function closeModal() {
      document.getElementById('confirmationModal').style.display = 'none';
    }

    function togglePassword() {
      var icon = document.getElementById("toggler");
      var input = document.getElementById("password")
      if (icon.classList.contains("bi-eye")) {
        icon.classList.add("bi-eye-slash");
        icon.classList.remove("bi-eye");
        input.type = "text";
      } else {
        icon.classList.add("bi-eye");
        icon.classList.remove("bi-eye-slash");
        input.type = "password";
      }
    }

    async function getInfo() {
      let scanningInfoBox = document.getElementById('scanning-info');
      let scanningLoader = document.getElementById('scanning-loader');
      let response = await fetch('/scan', {
        method: 'GET',
      })
        .catch(_ => {
          scanningLoader.style.display = 'none';
          scanningInfoBox.textContent =
            'There was an error while scanning networks. Please refresh the page or enter your wifi name manually';
        });

      if (response && response.status == 200) {
        var json = await response.json();
        scanningInfoBox.style.display = 'none';
        scanningLoader.style.display = 'none';

        var knownNetworks = json.filter((item) => item.saved);
        var otherNetworks = json.filter((item) => !item.saved);
        if (knownNetworks.length > 0) {
          document.getElementById('saved-networks').style.display = 'table';
          document.getElementById('other-networks-caption').style.display = 'block';
        }
        knownNetworks.forEach((item, row) => {
          appendWifiToTable("table-saved", item.name, item.open, item.rssi, false);
        });
        otherNetworks.forEach((item, row) => {
          appendWifiToTable("table-others", item.name, item.open, item.rssi, true);
        });
      } else if (response && response.status == 202) {
        setTimeout(getInfo, 2000); // repeat in 2s
      }
    }

    function appendWifiToTable(table, name, open, rssi, onClick) {
      var newRow = document.createElement('tr');
      if (onClick) {
        newRow.onclick = function () {
          onClickItemTable(this);
        };
      }
      var th = document.createElement('th');
      var td = document.createElement('td');
      th.textContent = name;
      newRow.appendChild(th);
      // append wifi strength
      var wifiIco = document.createElement('i');
      wifiIco.classList.add('bi');
      if (rssi > -55) {
        wifiIco.classList.add('bi-wifi');
      } else if (rssi > -70) {
        wifiIco.classList.add('bi-wifi-2');
      } else if (rssi > -100) {
        wifiIco.classList.add('bi-wifi-1');
      }
      td.appendChild(wifiIco);
      if (!open) {
        var lockIco = document.createElement('i');
        lockIco.classList.add('bi');
        lockIco.classList.add('bi-lock');
        td.appendChild(lockIco);
      }
      newRow.appendChild(td);
      document.getElementById(table).appendChild(newRow);
    }

    function onClickItemTable(x) {
      x.classList.add('selected');
      var siblings = Array.from(x.parentNode.children);
      siblings.forEach((sibling) => {
        if (sibling !== x) {
          sibling.classList.remove('selected');
        }
      });
      var value = x.querySelector('th').textContent;
      if (value) {
        document.getElementById('ssid').value = value;
        var passwordTag = document.getElementById('password');
        passwordTag.value = '';
        passwordTag.focus();
      }
    }

    function displayWifiInfo(response) {
      var ssid = response.ssid;
      var mac = response.mac;

      let message = "";
      if (ssid.length > 0) {
        message = `Connecting to SSID: ${ssid}. MAC address: ${mac}`;
      } else {
        message = `No AP set. MAC address: ${mac}`;
      }
      displayInfo(message);
    }

    function displayInfo(message) {
      var infoMessageBox = document.getElementById("info-message");
      infoMessageBox.textContent = message;
      infoMessageBox.style.display = "block";
    }

    function displayAlert(message, type) {
      var messageBox = document.getElementById("message");
      messageBox.style.display = "block";
      messageBox.textContent = message;
      messageBox.classList.remove("alert-primary");
      messageBox.classList.remove("alert-warning");

      messageBox.classList.add(`alert-${type}`);
    }

    function hideAlert() {
      var messageBox = document.getElementById("message");
      messageBox.style.display = "none";
    }

    function showLoader() {
      var loader = document.getElementById("loader-wrapper");
      loader.style.display = "block";
    }

    function hideLoader() {
      var loader = document.getElementById("loader-wrapper");
      loader.style.display = "none";
    }

    setTimeout(getInfo, 500);
  </script>
</head>

<body>
  <img src="/logo.svg" style="margin-left: auto; margin-right: auto; width: 50%; display: block;" />
  <h1>Wi-Fi Configuration</h1>
  <div class="div-container">
    <table id="saved-networks" style="display: none;">
      <caption>Saved Networks</caption>
      <tbody id="table-saved">
      </tbody>
    </table>
    <table>
      <caption style="display: none;" id="other-networks-caption">Other Networks</caption>
      <tbody id="table-others" class="hoverable">
      </tbody>
    </table>
    <p id="scanning-info">Scanning networks, please wait...</p>
    <div id="scanning-loader" class="loader"></div>
  </div>
  <div class="div-container">
    <div class="form-group">
      <label for="ssid">SSID</label>
      <input type="text" id="ssid" name="ssid" placeholder="Enter your Wi-Fi name">
    </div>
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" name="password" pattern=".{8,}" placeholder="Enter your Wi-Fi password">
      <i id="toggler" class="bi bi-eye" onclick="togglePassword()"></i>
    </div>
    <div class="form-group" id="custom_server_form_group" style="display: none;">
      <label for="server">API Server</label>
      <input type="url" id="server" name="server" placeholder="Enter your custom server without a trailing / (e.g. https://trmnl.app)">
    </div>
    <div class="form-group">
      <div class="alert alert-primary" id="message" role="alert" style="display: none;"></div>
    </div>
    <span>
      <button id="btnConnect" class="button button-success" onclick="connect()">Connect</button>
      <button id="btnRefresh" class="button button-primary" onclick="refresh()">Refresh</button>
    </span>
    <span style="margin-top: 20px;">
      <button id="btnRefresh" class="button button-secondary" onclick="confirmSoftReset()">Soft Reset</button>
      <button id="btnCustomServer" class="button button-primary" onclick="confirmCustomServer()">Custom Server</button>
    </span>
    <div class="form-group" style="margin-top: 10px;">
      <div class="alert alert-primary" id="info-message" role="alert" style="display: none;"></div>
    </div>
  </div>
  <div id="loader-wrapper">
    <div id="loader"></div>
  </div>
  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <p>Are you sure? Soft resetting your TRMNL device will delete all WiFi credentials,
        clear your Device's ID, and reset your API key.</p>
      <div class="modal-footer">
        <button class="button button-success" onclick="softReset()">Yes</button>
        <button class="button button-primary" onclick="closeModal()">No</button>
      </div>
    </div>
  </div>
  <!-- Confirmation Modal -->
  <div id="customServerWarningModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCustomServerModal()">&times;</span>
      <p>This button allows you to specify a custom API server (also known as BYOS) for your device.
         Most users don't want this, and will use the official server with their TRMNL. 
         Are you sure you want to have a custom server specified?</p>
      <div class="modal-footer">
        <button class="button button-success" onclick="showCustomServerInput()">Yes</button>
        <button class="button button-primary" onclick="closeCustomServerModal()">No</button>
      </div>
    </div>
  </div>
</body>
</html>
